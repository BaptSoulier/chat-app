<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Video and Text Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
    <style>
        body { display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; background-color: #f0f0f0; }
        #videos { display: flex; justify-content: space-around; width: 80%; }
        video { width: 300px; height: 200px; background-color: black; }
        #chat-container { width: 90%; max-width: 600px; height: 400px; border: 1px solid #ddd; padding: 20px; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; margin-top: 20px; }
        #messages { list-style-type: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .message { padding: 8px 16px; margin-bottom: 2px; border-radius: 4px; display: flex; }
        .user1 { background-color: #dcf8c6; align-self: flex-start; margin-right: auto; }
        .user2 { background-color: #ffefc3; align-self: flex-end; margin-left: auto; }
        .user-label { font-weight: bold; margin-right: 5px; }
        #message-form { display: flex; margin-top: 20px; }
        #message-input { flex-grow: 1; padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 10px 20px; border: none; background-color: #007BFF; color: white; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
<div id="videos">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
</div>
<div id="chat-container">
    <ul id="messages"></ul>
    <form id="message-form">
        <input id="message-input" autocomplete="off" placeholder="Type your message here...">
        <button type="submit">Send</button>
    </form>
</div>
<script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const socket = io();
    let peer;

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            localVideo.srcObject = stream;

            // Emit ready event when the video stream is ready
            socket.emit('ready');

            socket.on('userReady', id => {
                if (!peer) {
                    createPeer(id, true, stream);
                }
            });

            socket.on('receivedSignal', data => {
                if (!peer) {
                    createPeer(data.from, false, stream);
                }
                peer.signal(data.signal);
            });

            socket.on('userDisconnected', id => {
                if (peer) {
                    peer.destroy();
                    peer = null;
                }
            });
        });

    function createPeer(id, initiator, stream) {
        peer = new SimplePeer({ initiator, stream, trickle: false });

        peer.on('signal', signal => {
            socket.emit('signal', { to: id, signal });
        });

        peer.on('stream', remoteStream => {
            remoteVideo.srcObject = remoteStream;
        });
    }

    // Text chat logic
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const messagesList = document.getElementById('messages');
    const userId = Math.random() < 0.5 ? 'user1' : 'user2';

    socket.on('load old messages', (messages) => {
        messages.forEach((msg) => {
            displayMessage(msg);
        });
    });

    messageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (messageInput.value) {
            const message = { text: messageInput.value, userId: userId };
            socket.emit('chat message', message);
            messageInput.value = '';
        }
    });

    socket.on('chat message', (msg) => {
        displayMessage(msg);
    });

    function displayMessage(msg) {
        const item = document.createElement('li');
        item.classList.add('message', msg.userId === 'user1' ? 'user1' : 'user2');
        const label = document.createElement('span');
        label.classList.add('user-label');
        label.textContent = (msg.userId === 'user1' ? 'User 1: ' : 'User 2: ');
        const text = document.createElement('span');
        text.textContent = msg.text;
        item.appendChild(label);
        item.appendChild(text);
        messagesList.appendChild(item);
        messagesList.scrollTop = messagesList.scrollHeight;
    }
</script>
</body>
</html>
