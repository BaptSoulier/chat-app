<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Video Chat</title>
    <style>
        body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f0f0; }
        #videos { display: flex; justify-content: space-around; width: 80%; }
        video { width: 300px; height: 200px; background-color: black; }
    </style>
</head>
<body>
<div id="videos">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
</div>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const socket = io();
    let peer;

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            localVideo.srcObject = stream;

            // Emit ready event when the video stream is ready
            socket.emit('ready');

            socket.on('userReady', id => {
                if (!peer) {
                    createPeer(id, true, stream);
                }
            });

            socket.on('receivedSignal', data => {
                if (!peer) {
                    createPeer(data.from, false, stream);
                }
                peer.signal(data.signal);
            });
        });

    function createPeer(id, initiator, stream) {
        peer = new SimplePeer({ initiator, stream, trickle: false });

        peer.on('signal', signal => {
            socket.emit('signal', { to: id, signal });
        });

        peer.on('stream', remoteStream => {
            remoteVideo.srcObject = remoteStream;
        });
    }

    socket.on('userDisconnected', id => {
        if (peer) {
            peer.destroy();
            peer = null;
        }
    });
</script>
</body>
</html>
